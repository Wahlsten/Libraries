classdef sbp_obj
    % SBP operators
    properties
        Pinv;
        D1;
        D2;
        acc;
        BS;
    end
    methods
        function obj = createOperators(obj, grid_obj)
            
            type = 'wide';
            
            N  = grid_obj.N;
            dx = grid_obj.d;
            
            if obj.acc==2
                
                V           = dx*[0.5 ones(1,N-1) 0.5];
                obj.Pinv = sparse(diag(1./V));
                
                Q = full(0.5*sparse(diag([-1; zeros(N-1,1); 1]) ...
                    + diag(ones(N,1), 1) - diag(ones(N,1), -1)));
                
                obj.D1 = sparse(obj.Pinv*Q);
                
                if strcmp(type,'wide')
                    obj.D2 = sparse(obj.D1*obj.D1);
                    obj.BS = obj.D1;
                else
                    obj.D2 = ((diag(ones(N,1),1)+diag(ones(N,1),-1)-2*diag(ones(N+1,1),0)));
                    obj.D2(1,1)=1;obj.D2(1,2)=-2;obj.D2(1,3)=1;
                    obj.D2(N+1,N+1-2)=1;obj.D2(N+1,N)=-2;obj.D2(N+1,N+1)=1;
                    obj.D2 = sparse(obj.D2/dx^2);
                    
                    obj.BS = zeros(N+1);
                    obj.BS(1,1:3) = -[-3/2, 2, -1/2];
                    obj.BS(N+1,N-1:N+1)=fliplr(-[-3/2, 2, -1/2]);
                    obj.BS = sparse(obj.BS/dx);
                end
            end
            
            if obj.acc==4
                
                obj.Pinv = sparse((1/dx)*diag([48/17 48/59 48/43 48/49 ...
                    ones(1,N-7) 48/49 48/43 48/59 48/17]));
                
                diagQ = ones(N+1,1)*[1/12 -2/3 0 2/3 -1/12];
                Q = sparse(spdiags(diagQ,[-2:2],N+1,N+1));
                Q(1:4,1:4) = [-1/2 59/96 -1/12 -1/32;-59/96 0 59/96 0;...
                    1/12 -59/96 0 59/96; 1/32 0 -59/96 0];
                Q(N-2:N+1,N-2:N+1) = -rot90(Q(1:4,1:4), 2); %Q(N-2:N+1,N-2:N+1) = -flipud(fliplr(Q(1:4,1:4)));
                obj.D1 = sparse(obj.Pinv*Q);
                
                if strcmp(type,'wide')
                    obj.D2 = sparse(obj.D1*obj.D1);
                    obj.BS = obj.D1;
                else
                    dia = ones(N+1,1)*[-1/12 4/3 -5/2 4/3 -1/12];
                    obj.D2 = spdiags(dia,[-2:2],N+1,N+1);
                    obj.D2(1:4,1:6) = [2    -5      4      -1     0     0; ...
                        1    -2      1      0      0     0; ...
                        -4/43 59/43 -110/43 59/43 -4/43   0; ...
                        -1/49   0    59/49 -118/49 64/49 -4/49];
                    obj.D2(N+1-3:N+1,N+1-5:N+1) = flipud(fliplr(obj.D2(1:4,1:6)));
                    obj.D2 = sparse(obj.D2/(dx^2));
                    
                    obj.BS = zeros(N+1);
                    obj.BS(1,1:4) = [11/6,-3,3/2,-1/3];
                    obj.BS(N+1,N+1:-1:N-2) = obj.BS(1,1:4);
                    obj.BS = sparse(obj.BS/dx);
                end
            end
            
            if obj.acc==6
                
                P = diag(ones(N+1,1),0);
                P(1:6,1:6)=diag([13649/43200,12013/8640,2711/4320,5359/4320,7877/8640, ...
                    43801/43200]);
                P(N+1-5:N+1,N+1-5:N+1)=fliplr(flipud(diag([13649/43200,12013/8640, ...
                    2711/4320,5359/4320,7877/8640,43801/43200])));
                
                P = dx*P;
                obj.Pinv = sparse(inv(P));
                
                % One free parameter x1
                % One optimized value is x1=0.70127127127127 = 331/472
                x1 = 0.70127127127127;
                
                obj.D1 = (1/60*diag(ones(N+1-3,1),3)-9/60*diag(ones(N+1-2,1),2)+45/60*diag(ones(N,1),1)-45/60*diag(ones(N,1),-1)+9/60*diag(ones(N+1-2,1),-2)-1/60*diag(ones(N+1-3,1),-3));
                
                obj.D1(1:6,1:9)=[-21600/13649, 43200/13649*x1-7624/40947, -172800/13649*x1+ ...
                    715489/81894, 259200/13649*x1-187917/13649, -172800/13649* ...
                    x1+735635/81894, 43200/13649*x1-89387/40947, 0, 0, 0; ...
                    -8640/12013*x1+7624/180195, 0, 86400/12013*x1-57139/12013, ...
                    -172800/12013*x1+745733/72078, 129600/12013*x1-91715/12013, ...
                    -34560/12013*x1+240569/120130, 0, 0, 0; 17280/2711*x1-715489/162660, -43200/2711*x1+57139/5422, 0, 86400/2711*x1-176839/8133, -86400/2711*x1+242111/10844, 25920/2711*x1-182261/27110, 0, 0, 0; -25920/5359*x1+187917/53590, 86400/5359*x1-745733/64308, -86400/5359*x1+176839/16077, 0, 43200/5359*x1-165041/32154, -17280/5359*x1+710473/321540, 72/5359, 0, 0; 34560/7877*x1-147127/47262, -129600/7877*x1+91715/7877, 172800/7877*x1-242111/15754, -86400/7877*x1+165041/23631, 0, 8640/7877*x1, -1296/7877, 144/7877, 0; -43200/43801*x1+89387/131403, 172800/43801*x1-240569/87602, -259200/43801*x1+182261/43801, 172800/43801*x1-710473/262806, -43200/43801*x1, 0, 32400/43801, -6480/43801, 720/43801];
                obj.D1(N+1-5:N+1,N+1-8:N+1)=flipud( fliplr(-obj.D1(1:6,1:9)));
                obj.D1 = sparse(obj.D1/dx);
                
                if strcmp(type,'wide')
                    obj.D2 = sparse(obj.D1*obj.D1);
                    obj.BS = obj.D1;
                else
                    obj.D2 = (2*diag(ones(N+1-3,1),3)-27*diag(ones(N+1-2,1),2)+270*diag(ones(N,1),1)+270*diag(ones(N,1),-1)-27*diag(ones(N+1-2,1),-2)+2*diag(ones(N+1-3,1),-3)-490*diag(ones(N+1,1),0))/180;
                    obj.D2(1:6,1:9)=[114170/40947, -438107/54596, 336409/40947, -276997/81894, 3747/13649, 21035/163788, 0, 0, 0;6173/5860, -2066/879, 3283/1758, -303/293, 2111/3516, -601/4395, 0, 0, 0;-52391/81330, 134603/32532, -21982/2711, 112915/16266, -46969/16266, 30409/54220, 0, 0, 0;68603/321540, -12423/10718, 112915/32154, -75934/16077, 53369/21436, -54899/160770, 48/5359, 0, 0;-7053/39385, 86551/94524, -46969/23631, 53369/15754, -87904/23631, 820271/472620, -1296/7877, 96/7877, 0;21035/525612, -24641/131403, 30409/87602, -54899/131403, 820271/525612, -117600/43801, 64800/43801, -6480/43801, 480/43801];
                    obj.D2(N+1-5:N+1,N+1-8:N+1)=flipud( fliplr(obj.D2(1:6,1:9) ) );
                    obj.D2 = sparse(obj.D2/dx^2);
                    
                    obj.BS = zeros(N+1);
                    obj.BS(1,1:5) = -[-25/12, 4, -3, 4/3, -1/4];
                    obj.BS(N+1,N-3:N+1) = fliplr(-[-25/12, 4, -3, 4/3, -1/4]);
                    obj.BS = sparse(obj.BS/dx);
                end
                
            end
            
            if obj.acc==8
                
                P = diag(ones(N+1,1),0);
                P(1:8,1:8)=diag([1498139/5080320, 1107307/725760, 20761/80640, 1304999/725760, 299527/725760, 103097/80640, 670091/725760, 5127739/5080320]);
                P(N+1-7:N+1,N+1-7:N+1)=fliplr(flipud(diag([1498139/5080320, 1107307/725760, 20761/80640, 1304999/725760, 299527/725760, 103097/80640, 670091/725760, 5127739/5080320])));
                
                P = dx*P;
                obj.Pinv = sparse(inv(P));
                
                r67 = 0.69789473684211;
                r68 = -0.12052631578947;
                r78 = 0.75868421052632;
                
                obj.D1 = -(1/280*diag(ones(N+1-4,1),4)-4/105*diag(ones(N+1-3,1),3)+1/5*diag(ones(N+1-2,1),2)-4/5*diag(ones(N,1),1)+4/5*diag(ones(N,1),-1)-1/5*diag(ones(N+1-2,1),-2)+4/105*diag(ones(N+1-3,1),-3)-1/280*diag(ones(N+1-4,1),-4));
                obj.D1(1:8,1:12)=[-2540160/1498139, -142642467/5992556+50803200/1498139*r78+5080320/1498139*r67+25401600/1498139*r68, 705710031/5992556-228614400/1498139*r78-25401600/1498139*r67-121927680/1498139*r68, -3577778591/17977668+381024000/1498139*r78+50803200/1498139*r67+228614400/1498139*r68, 203718909/1498139-254016000/1498139*r78-50803200/1498139*r67-203212800/1498139*r68, -32111205/5992556+25401600/1498139*r67+76204800/1498139*r68, -652789417/17977668+76204800/1498139*r78-5080320/1498139*r67, 74517981/5992556-25401600/1498139*r78-5080320/1498139*r68, 0, 0, 0, 0;142642467/31004596-7257600/1107307*r78-725760/1107307*r67-3628800/1107307*r68, 0, -141502371/2214614+91445760/1107307*r78+10886400/1107307*r67+50803200/1107307*r68, 159673719/1107307-203212800/1107307*r78-29030400/1107307*r67-127008000/1107307*r68, -1477714693/13287684+152409600/1107307*r78+32659200/1107307*r67+127008000/1107307*r68, 11652351/2214614-17418240/1107307*r67-50803200/1107307*r68, 36069450/1107307-50803200/1107307*r78+3628800/1107307*r67, -536324953/46506894+17418240/1107307*r78+3628800/1107307*r68, 0, 0, 0, 0;-18095129/134148+3628800/20761*r78+403200/20761*r67+1935360/20761*r68, 47167457/124566-10160640/20761*r78-1209600/20761*r67-5644800/20761*r68, 0, -120219461/124566+25401600/20761*r78+4032000/20761*r67+16934400/20761*r68, 249289259/249132-25401600/20761*r78-6048000/20761*r67-22579200/20761*r68, -2611503/41522+3628800/20761*r67+10160640/20761*r68, -7149666/20761+10160640/20761*r78-806400/20761*r67, 37199165/290654-3628800/20761*r78-806400/20761*r68, 0, 0, 0, 0;3577778591/109619916-54432000/1304999*r78-7257600/1304999*r67-32659200/1304999*r68, -159673719/1304999+203212800/1304999*r78+29030400/1304999*r67+127008000/1304999*r68, 360658383/2609998-228614400/1304999*r78-36288000/1304999*r67-152409600/1304999*r68, 0, -424854441/5219996+127008000/1304999*r78+36288000/1304999*r67+127008000/1304999*r68, 22885113/2609998-29030400/1304999*r67-76204800/1304999*r68, 158096578/3914997-76204800/1304999*r78+7257600/1304999*r67, -296462325/18269986+29030400/1304999*r78+7257600/1304999*r68, 0, 0, 0, 0;-203718909/2096689+36288000/299527*r78+7257600/299527*r67+29030400/299527*r68, 1477714693/3594324-152409600/299527*r78-32659200/299527*r67-127008000/299527*r68, -747867777/1198108+228614400/299527*r78+54432000/299527*r67+203212800/299527*r68, 424854441/1198108-127008000/299527*r78-36288000/299527*r67-127008000/299527*r68, 0, -17380335/1198108+10886400/299527*r67+25401600/299527*r68, -67080435/1198108+25401600/299527*r78-3628800/299527*r67, 657798011/25160268-10886400/299527*r78-3628800/299527*r68, -2592/299527, 0, 0, 0;1529105/1237164-403200/103097*r67-1209600/103097*r68, -3884117/618582+1935360/103097*r67+5644800/103097*r68, 2611503/206194-3628800/103097*r67-10160640/103097*r68, -7628371/618582+3225600/103097*r67+8467200/103097*r68, 5793445/1237164-1209600/103097*r67-2822400/103097*r68, 0, 80640/103097*r67, 80640/103097*r68, 3072/103097, -288/103097, 0, 0;93255631/8041092-10886400/670091*r78+725760/670091*r67, -36069450/670091+50803200/670091*r78-3628800/670091*r67, 64346994/670091-91445760/670091*r78+7257600/670091*r67, -158096578/2010273+76204800/670091*r78-7257600/670091*r67, 67080435/2680364-25401600/670091*r78+3628800/670091*r67, -725760/670091*r67, 0, 725760/670091*r78, -145152/670091, 27648/670091, -2592/670091, 0;-3921999/1079524+25401600/5127739*r78+5080320/5127739*r68, 536324953/30766434-121927680/5127739*r78-25401600/5127739*r68, -334792485/10255478+228614400/5127739*r78+50803200/5127739*r68, 296462325/10255478-203212800/5127739*r78-50803200/5127739*r68, -657798011/61532868+76204800/5127739*r78+25401600/5127739*r68, -5080320/5127739*r68, -5080320/5127739*r78, 0, 4064256/5127739, -1016064/5127739, 193536/5127739, -18144/5127739];
                obj.D1(N+1-7:N+1,N+1-11:N+1)=flipud( fliplr(-obj.D1(1:8,1:12)));
                obj.D1 = sparse(obj.D1/dx);
                
                if strcmp(type,'wide')
                    obj.D2 = sparse(obj.D1*obj.D1);
                    obj.BS = obj.D1;
                else
                    obj.D2 = (-1/560*diag(ones(N+1-4,1),4)+8/315*diag(ones(N+1-3,1),3)-1/5*diag(ones(N+1-2,1),2)+8/5*diag(ones(N,1),1)+8/5*diag(ones(N,1),-1)-1/5*diag(ones(N+1-2,1),-2)+8/315*diag(ones(N+1-3,1),-3)-1/560*diag(ones(N+1-4,1),-4)-205/72*diag(ones(N+1,1),0));
                    obj.D2(1:8,1:12)=[4870382994799/1358976868290, -893640087518/75498714905,926594825119/60398971924, -1315109406200/135897686829,39126983272/15099742981, 12344491342/75498714905, -451560522577/2717953736580, 0, 0, 0, 0, 0;333806012194/390619153855, -154646272029/111605472530, 1168338040/33481641759, 82699112501/133926567036, -171562838/11160547253, -28244698346/167408208795, 11904122576/167408208795, -2598164715/312495323084, 0, 0, 0, 0;7838984095/52731029988, 1168338040/5649753213, -88747895/144865467, 423587231/627750357, -43205598281/22599012852, 4876378562/1883251071, -5124426509/3766502142, 10496900965/39548272491, 0, 0, 0, 0;-94978241528/828644350023, 82699112501/157837019052, 1270761693/13153084921, -167389605005/118377764289, 48242560214/39459254763, -31673996013/52612339684, 43556319241/118377764289, -44430275135/552429566682, 0, 0, 0, 0;1455067816/21132528431, -171562838/3018932633, -43205598281/36227191596, 48242560214/9056797899, -52276055645/6037865266, 57521587238/9056797899, -80321706377/36227191596, 8078087158/21132528431, -1296/299527, 0, 0, 0;10881504334/327321118845, -28244698346/140280479505, 4876378562/9352031967, -10557998671/12469375956, 57521587238/28056095901, -278531401019/93520319670, 73790130002/46760159835, -137529995233/785570685228, 2048/103097, -144/103097, 0, 0;-135555328849/8509847458140, 11904122576/101307707835, -5124426509/13507694378, 43556319241/60784624701, -80321706377/81046166268, 73790130002/33769235945, -950494905688/303923123505, 239073018673/141830790969, -145152/670091, 18432/670091, -1296/670091, 0;0, -2598164715/206729925524, 10496900965/155047444143, -44430275135/310094888286, 425162482/2720130599, -137529995233/620189776572, 239073018673/155047444143, -144648000000/51682481381, 8128512/5127739, -1016064/5127739, 129024/5127739, -9072/5127739];
                    obj.D2(N+1-7:N+1,N+1-11:N+1)=flipud( fliplr(obj.D2(1:8,1:12) ) );
                    obj.D2 = sparse(obj.D2/dx^2);
                    
                    obj.BS = zeros(N+1,N+1);
                    obj.BS(1,1:7) = -[-4723/2100, 839/175, -157/35, 278/105, -103/140, -1/175, 6/175];
                    obj.BS(N+1,N-5:N+1) = fliplr(-[-4723/2100, 839/175, -157/35, 278/105, -103/140, -1/175, 6/175]);
                    obj.BS = sparse(obj.BS/dx);
                end
            end
        end
    end
end
